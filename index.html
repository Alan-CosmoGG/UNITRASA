<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>UNITRASA - Dashboard de Monitoreo Moderno 🚀</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
    />
    <style>
        /* ------------------------------------------------------------------- */
        /* ESTRUCTURA GENERAL Y RESET - MÁXIMO ESPACIO */
        /* ------------------------------------------------------------------- */
        *, *::before, *::after {
            box-sizing: border-box;
        }
        html, body {
            margin: 0; padding: 0; 
            height: 100%;
            font-family: 'Roboto', sans-serif;
            background: #f8f9fb; /* Fondo muy claro y profesional */
            color: #2c3e50; 
            overflow: hidden; 
        }
        body {
            display: flex;
            flex-direction: column; 
            height: 100vh;
        }

        /* Header profesional */
        header {
            flex-shrink: 0;
            background: #0078d4; /* Azul corporativo primario */
            color: white;
            padding: 0.9rem 1.5rem;
            font-weight: 500;
            font-size: 1.6rem;
            z-index: 1000;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }

        /* Contenedor principal dividido - Mapa vs. Panel Lateral */
        #container {
            display: flex;
            flex: 1; 
            height: 100%; 
        }

        /* Mapa - Módulo Grande */
        #map {
            flex: 1 1 65%;
            height: 100%;
        }

        /* ------------------------------------------------------------------- */
        /* PANEL DERECHO - ESTRUCTURA DE CUADRÍCULA 2x2 (GRID LAYOUT) */
        /* ------------------------------------------------------------------- */
        #panelDerecho {
            flex: 1 1 35%;
            padding: 1rem; 
            background: #eef2f6; /* Fondo de panel ligeramente gris */
            box-shadow: -6px 0 20px rgba(0, 0, 0, 0.08);
            min-width: 450px; /* Aumentamos el ancho mínimo para la cuadrícula 2x2 */
            
            /* CLAVE: Diseño de Cuadrícula 2 columnas / 2 filas */
            display: grid;
            grid-template-columns: 1fr 1fr; /* Dos columnas de igual ancho */
            grid-template-rows: auto 1fr; /* Fila superior fija, Fila inferior expandible */
            gap: 1rem; /* Espacio entre módulos */
            height: 100%; 
        }

        /* Estilo para cada Módulo (Tarjeta/Card) */
        .modulo-card {
            background: #ffffff;
            padding: 1.25rem;
            border-radius: 8px; /* Bordes más suaves */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); /* Sombra sutil */
            border: 1px solid #eef2f6;
            overflow: hidden; 
        }
        
        /* Módulo 1: Creación de Viaje (Arriba a la izquierda) */
        #moduloCreacion {
            grid-column: 1 / 2;
            grid-row: 1 / 2;
        }

        /* Módulo 2: Detalles de la Unidad (Arriba a la derecha) */
        #moduloDescripcion {
            grid-column: 2 / 3;
            grid-row: 1 / 2;
        }

        /* Módulo 3: Rutas Activas (Abajo, expandido para ocupar toda la fila) */
        #moduloMonitoreo {
            grid-column: 1 / 3; /* Ocupa las dos columnas de la fila inferior */
            grid-row: 2 / 3;
            display: flex;
            flex-direction: column;
            min-height: 0; 
        }

        /* Títulos de Módulos */
        .modulo-card h2 {
            margin-top: 0; margin-bottom: 1rem; color: #172b4d; 
            font-weight: 700; font-size: 1.2rem;
            border-bottom: 2px solid #eef2f6;
            padding-bottom: 0.5rem;
        }
        
        /* Contenedor de lista de rutas dentro del módulo de monitoreo */
        #rutasActivasContainer {
            flex-grow: 1; 
            overflow-y: auto; /* El único scroll grande de esta sección */
            padding-right: 0.5rem; 
        }

        /* --- Estilos de Control y Datos --- */
        #formGrid {
            display: grid; grid-template-columns: 1fr; /* Cambiado a 1 columna para optimizar el espacio pequeño */
            gap: 0.6rem;
        }
        #formGrid > div:nth-child(3) { margin-top: 0.5rem;}

        label { font-size: 0.85rem; margin-bottom: 0.2rem; }
        select { font-size: 0.9rem; padding: 0.5rem 0.75rem; border-radius: 6px; }
        
        #botonesContenedor { display: flex; gap: 0.75rem; align-items: center; margin-top: 0.5rem; }
        button.add-stop { padding: 0.5rem 0.8rem; font-size: 0.9rem; }
        button[type="submit"] { padding: 0.6rem 1.5rem; font-weight: 700; }
        
        .rutaItem {
            margin-bottom: 0.6rem;
            padding: 0.8rem 1rem;
            border: 1px solid #f4f7fa;
            border-left: 4px solid #c7d0d9;
        }
        .rutaItem.selected { border-left: 4px solid #ff6600; background-color: #fff8f5; }
        .rutaDesc strong { font-size: 0.95rem; }
        .rutaDesc span { font-size: 0.85rem; }
        .btnVer { padding: 0.4rem 0.7rem; font-size: 0.8rem; }

        /* Estilos de Descripción */
        #panelDescripcion h4 { font-size: 1rem; color: #0078d4; margin-bottom: 0.5rem; }
        #panelDescripcion p { font-size: 0.85rem; margin: 0.1rem 0; }
        #panelDescripcion strong { font-weight: 500; }

    </style>
</head>
<body>
<header>UNITRASA - Dashboard de Monitoreo Moderno 🚀</header>

<div id="container">
    <div id="map" role="region" aria-label="Mapa principal con visualización de rutas en tiempo real"></div>

    <div id="panelDerecho" role="main" aria-label="Panel de control modular y widgets">
        
        <div id="moduloCreacion" class="modulo-card">
            <h2>Crear Nuevo Trayecto</h2>
            <form id="formulario" autocomplete="off" aria-label="Formulario para iniciar nuevas rutas de monitoreo">
                <div id="formGrid"> 
                    <div>
                        <label for="origen">Origen:</label>
                        <select id="origen" required></select>
                    </div>

                    <div>
                        <label for="destino">Destino:</label>
                        <select id="destino" required></select>
                    </div>

                    <div>
                        <label>Puntos Intermedios:</label>
                        <div id="botonesContenedor">
                            <button type="button" class="add-stop" id="agregarParada" title="Agregar un punto de parada intermedio">Agregar Parada</button>
                            <button type="submit" aria-label="Calcular y registrar el nuevo viaje">Iniciar Monitoreo</button>
                        </div>
                        <div id="paradasContainer" aria-live="polite" aria-label="Lista de paradas intermedias seleccionadas"></div>
                    </div>
                </div>
            </form>
        </div>

        <div id="moduloDescripcion" class="modulo-card">
            <h2>Detalles de la Unidad</h2>
            <div id="panelDescripcion" aria-live="polite" aria-atomic="true">
                <p>Seleccione una ruta activa para ver sus detalles, progreso y resaltarla en el mapa.</p>
            </div>
        </div>

        <div id="moduloMonitoreo" class="modulo-card">
            <h2>Rutas Activas (Monitoreo) 🚍</h2>
            <div id="rutasActivasContainer" role="list" aria-label="Lista de rutas de transporte actualmente en movimiento">
                </div>
        </div>
        
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script>
    // La lógica JavaScript no cambia, solo se adapta a la nueva estructura del DOM.
    const apiKey = "5b3ce3597851110001cf624807a1d5c5f6c8482e99d92b7b0aee6db9";

    const estados = {
        "Aguascalientes": [21.8823, -102.2916], "Baja California": [32.5149, -117.0382], "Baja California Sur": [24.1426, -110.3128],
        "Campeche": [19.845, -90.5234], "Chiapas": [16.75, -93.1167], "Chihuahua": [28.6353, -106.0889],
        "Ciudad de México": [19.4326, -99.1332], "Coahuila": [25.4383, -100.9736], "Colima": [19.2433, -103.7241],
        "Durango": [24.0277, -104.6532], "Estado de México": [19.35, -99.75], "Guanajuato": [21.0181, -101.2591],
        "Guerrero": [17.5545, -99.5058], "Hidalgo": [20.1011, -98.7591], "Jalisco": [20.6597, -103.3496],
        "Michoacán": [19.7008, -101.186], "Morelos": [18.6813, -99.1013], "Nayarit": [21.7514, -104.8455],
        "Nuevo León": [25.6866, -100.3161], "Oaxaca": [17.0732, -96.7266], "Puebla": [19.0414, -98.2063],
        "Querétaro": [20.5888, -100.3899], "Quintana Roo": [18.51, -88.2961], "San Luis Potosí": [22.1565, -100.9855],
        "Sinaloa": [24.8091, -107.394], "Sonora": [29.0729, -110.9559], "Tabasco": [17.9869, -92.9303],
        "Tamaulipas": [23.7369, -99.1411], "Tlaxcala": [19.3139, -98.24], "Veracruz": [19.1903, -96.1535],
        "Yucatán": [20.9674, -89.5926], "Zacatecas": [22.7709, -102.5832]
    };

    const selectOrigen = document.getElementById("origen");
    const selectDestino = document.getElementById("destino");
    const paradasContainer = document.getElementById("paradasContainer");
    const rutasActivasContainer = document.getElementById("rutasActivasContainer");
    const panelDescripcion = document.getElementById("panelDescripcion");

    let map = null;
    let rutasActivas = [];
    let marcadoresImportantes = [];
    let rutaSeleccionadaIndex = null;

    function llenarSelect(select) {
        select.innerHTML = "";
        const defaultOption = document.createElement("option");
        defaultOption.value = "";
        defaultOption.text = "Seleccione un Estado...";
        defaultOption.disabled = true;
        defaultOption.selected = true;
        select.appendChild(defaultOption);
        for (const estado in estados) {
            const option = document.createElement("option");
            option.value = estado;
            option.text = estado;
            select.appendChild(option);
        }
    }
    llenarSelect(selectOrigen);
    llenarSelect(selectDestino);

    function getColor(i) {
        const colores = ["#0078d4", "#2ecc71", "#f1c40f", "#e74c3c", "#9b59b6", "#e67e22", "#1abc9c", "#3498db"];
        return colores[i % colores.length];
    }
    
    document.getElementById("agregarParada").addEventListener("click", () => {
        const div = document.createElement("div");
        div.style.display = "flex";
        div.style.alignItems = "center";
        div.style.gap = "0.5rem";
        const selectParada = document.createElement("select");
        llenarSelect(selectParada);
        const btnQuitar = document.createElement("button");
        btnQuitar.type = "button";
        btnQuitar.textContent = "✖";
        btnQuitar.className = "remove-stop";
        btnQuitar.title = "Quitar parada";
        btnQuitar.addEventListener("click", () => div.remove());
        selectParada.addEventListener('change', () => {
            if (selectParada.value) {
                div.setAttribute('data-stop', selectParada.value);
            }
        });
        div.appendChild(selectParada);
        div.appendChild(btnQuitar);
        paradasContainer.appendChild(div);
    });

    function initMap() {
        map = L.map("map").setView([23, -102], 6);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
    }
    initMap();

    function limpiarMarcadoresImportantes() {
        marcadoresImportantes.forEach(m => map.removeLayer(m));
        marcadoresImportantes = [];
    }
    
    function crearMarcadorImportante(latlng, texto, color, iconoHTML) {
        const defaultIcon = `<div style="background-color: ${color}; border-radius: 50%; width: 16px; height: 16px; border: 3px solid white; box-shadow: 0 0 8px ${color};" title="${texto}"></div>`;
        const htmlContent = iconoHTML || defaultIcon;
        const icon = L.divIcon({
            html: htmlContent, className: "custom-marker", iconSize: [24, 24], iconAnchor: [12, 12]
        });
        const marker = L.marker(latlng, { icon });
        marker.bindPopup(`<strong>${texto}</strong>`);
        marker.addTo(map);
        marcadoresImportantes.push(marker);
    }
    
    function agregarRutaLista(viaje, index) {
        const div = document.createElement("div");
        div.className = "rutaItem";
        div.tabIndex = 0;
        div.setAttribute("role", "listitem");
        div.setAttribute("aria-label", `Ruta ${viaje.unidad} desde ${viaje.origen} a ${viaje.destino}`);

        div.innerHTML = `
            <div class="rutaDesc">
                <strong>${viaje.unidad}</strong>
                <span>${viaje.origen} → ${viaje.destino}</span>
                ${viaje.paradas.length > 0 ? `<br/><small>(${viaje.paradas.length} paradas)</small>` : ""}
            </div>
            <button class="btnVer" aria-label="Ver detalles de la ruta ${viaje.unidad}">Detalles</button>
        `;

        div.querySelector(".btnVer").addEventListener("click", (ev) => {
            ev.stopPropagation();
            seleccionarRuta(index);
        });
        div.addEventListener("click", () => {
            seleccionarRuta(index);
        });
        rutasActivasContainer.appendChild(div);
    }

    function renderListaRutas() {
        rutasActivasContainer.innerHTML = "";
        rutasActivas.forEach((ruta, i) => {
             agregarRutaLista(ruta.viajeInfo, i);
        });
        
        if (rutaSeleccionadaIndex !== null && rutasActivas[rutaSeleccionadaIndex]) {
            seleccionarRuta(rutaSeleccionadaIndex, false);
        } else if (rutasActivas.length > 0) {
            seleccionarRuta(0, false);
        } else {
             panelDescripcion.innerHTML = '<p>No hay rutas activas. Cree un nuevo trayecto para comenzar el monitoreo.</p>';
        }
    }

    function mostrarDescripcionRuta(viaje) {
        panelDescripcion.innerHTML = `
            <h4>Unidad: ${viaje.unidad}</h4>
            <p><strong>Origen:</strong> ${viaje.origen}</p>
            <p><strong>Destino:</strong> ${viaje.destino}</p>
            <p><strong>Duración Est.:</strong> ${viaje.duracion}</p>
            <p><strong>Distancia:</strong> ${viaje.distancia} km</p>
            <p><strong>Paradas:</strong> ${viaje.paradas.length > 0 ? viaje.paradas.join(", ") : "Ninguna"}</p>
            <p><strong>Llegada Est.:</strong> ${new Date(viaje.llegada).toLocaleTimeString('es-MX')}</p>
        `;
    }

    function seleccionarRuta(index, centrarMapa = true) {
        const anteriores = document.querySelectorAll(".rutaItem.selected");
        anteriores.forEach(el => el.classList.remove("selected"));

        const nuevo = rutasActivasContainer.children[index];
        if (nuevo) nuevo.classList.add("selected");
        rutaSeleccionadaIndex = index;

        limpiarMarcadoresImportantes();
        
        if (rutasActivas[index]) {
            const viaje = rutasActivas[index].viajeInfo;
            crearMarcadorImportante(estados[viaje.origen], "Origen: " + viaje.origen, "#0078d4", '<div style="font-size: 20px;">📍</div>');
            viaje.paradas.forEach(p => crearMarcadorImportante(estados[p], "Parada: " + p, "#ffc107", '<div style="font-size: 20px;">🛑</div>'));
            crearMarcadorImportante(estados[viaje.destino], "Destino: " + viaje.destino, "#d9534f", '<div style="font-size: 20px;">🏁</div>');
            mostrarDescripcionRuta(viaje);
        }

        rutasActivas.forEach(({ polyline, marcador }, i) => {
            const isSelected = i === index;
            const baseColor = getColor(i);
            const highLightColor = "#ff6600";
            
            polyline.setStyle({ color: isSelected ? highLightColor : baseColor, weight: isSelected ? 8 : 5, opacity: isSelected ? 1 : 0.6 });
            if(isSelected) polyline.bringToFront();
            if (marcador && isSelected) marcador.openPopup();
        });

        if (centrarMapa && rutasActivas[index]) {
            const bounds = rutasActivas[index].polyline.getBounds();
            map.fitBounds(bounds.pad(0.2));
        }
    }

    document.getElementById("formulario").addEventListener("submit", async (e) => {
        e.preventDefault();

        const origen = selectOrigen.value;
        const destino = selectDestino.value;

        if (!origen || !destino || origen === destino) {
            alert("Seleccione un origen y destino diferentes y válidos.");
            return;
        }

        const paradas = [];
        paradasContainer.querySelectorAll("select").forEach((sel) => {
            if (sel.value && sel.value !== origen && sel.value !== destino && !paradas.includes(sel.value)) {
                 paradas.push(sel.value);
            }
        });

        const coords = construirCoordenadas(origen, paradas, destino);
        
        const submitButton = e.submitter;
        submitButton.disabled = true;
        submitButton.textContent = "Calculando Ruta...";

        try {
            const profile = 'driving-car'; 
            
            const resp = await fetch(
                `https://api.openrouteservice.org/v2/directions/${profile}/geojson`,
                {
                    method: "POST",
                    headers: { "Content-Type": "application/json", Authorization: apiKey },
                    body: JSON.stringify({ coordinates: coords, preference: "shortest" }),
                }
            );
            if (!resp.ok) throw new Error(`Error HTTP ${resp.status} - ${resp.statusText}`);

            const data = await resp.json();
            
            if (data.features.length === 0) {
                 throw new Error("No se pudo calcular una ruta terrestre válida.");
            }

            const routeCoords = data.features[0].geometry.coordinates.map((c) => [ c[1], c[0] ]);

            const summary = data.features[0].properties.summary;
            const distKm = (summary.distance / 1000).toFixed(1);
            const durMin = Math.round(summary.duration / 60);
            const durStr = `${Math.floor(durMin / 60)}h ${durMin % 60}m`;

            const salida = new Date();
            const llegada = new Date(salida.getTime() + durMin * 60000);

            const unidad = "UN-" + Math.floor(Math.random() * 900 + 100);

            const viaje = {
                unidad, origen, destino, paradas,
                salida: salida.toISOString(), llegada: llegada.toISOString(), duracion: durStr, distancia: distKm,
            };
            
            const polyline = L.polyline(routeCoords, { color: getColor(rutasActivas.length), weight: 5, opacity: 0.75 }).addTo(map);
            const marcador = L.marker(routeCoords[0], { icon: L.divIcon({ html: `<div style="font-size: 24px;">🚚</div>`, className: "truck-marker", iconSize: [24, 24], iconAnchor: [12, 12] }) });
            marcador.bindPopup(`<strong>${unidad}</strong><br>En camino a: ${destino}`);
            marcador.addTo(map);

            rutasActivas.push({ polyline, marcador, routeCoords, idx: 0, viajeInfo: viaje });

            paradasContainer.innerHTML = '';
            selectOrigen.value = "";
            selectDestino.value = "";

            renderListaRutas();
            seleccionarRuta(rutasActivas.length - 1);

        } catch (err) {
            alert("Error al calcular la ruta. Verifique la conexión o los puntos geográficos. Detalle: " + err.message);
            console.error(err);
        } finally {
            submitButton.disabled = false;
            submitButton.textContent = "Iniciar Monitoreo";
        }
    });
    
    function construirCoordenadas(origen, paradas, destino) {
        let coords = [];
        coords.push([estados[origen][1], estados[origen][0]]);
        for (const parada of paradas) {
            coords.push([estados[parada][1], estados[parada][0]]);
        }
        coords.push([estados[destino][1], estados[destino][0]]);
        return coords;
    }

    setInterval(() => {
        rutasActivas.forEach((ruta, index) => {
            if (ruta.idx < ruta.routeCoords.length) {
                const currentCoords = ruta.routeCoords[ruta.idx];
                ruta.marcador.setLatLng(currentCoords);
                if (index === rutaSeleccionadaIndex) {
                    const progress = ((ruta.idx / ruta.routeCoords.length) * 100).toFixed(0);
                    if(ruta.marcador.getPopup() && ruta.marcador.getPopup().isOpen()) {
                        ruta.marcador.setPopupContent(`<strong>${ruta.viajeInfo.unidad}</strong><br>Progreso: ${progress}%`);
                    }
                }
                ruta.idx += 10;
            } else {
                if (ruta.idx === ruta.routeCoords.length) {
                    ruta.marcador.setPopupContent(`<strong>${ruta.viajeInfo.unidad}</strong><br>¡Viaje finalizado!`).openPopup();
                    ruta.idx++;
                }
            }
        });
    }, 500);

    renderListaRutas();
</script>
</body>
</html>